<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WHEEL</title>
    <link rel="icon" type="image/png" href="https://github.com/ellandeperez/MHBestiary/blob/main/MHImages/0_Icons/question.png?raw=true">
    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <!-- Stylesheet -->
    <link rel="stylesheet" href="style.css" />
  </head>
  <style>
    @font-face {
        font-family: 'Albertus MT Std Regular';
        font-style: normal;
        font-weight: normal;
        src: local('Albertus MT Std Regular'), url('fonts/FuenteMH.woff') format('woff');
    }
    * {
    padding: 0;
    margin: 0;
    box-sizing: border-box;
    font-family: "Poppins", sans-serif;
    }
    body {
    height: 100vh;
    background-image: url('https://github.com/ellandeperez/MHBestiary/blob/main/MHImages/background.jpg?raw=true');
    background-size: cover;
    background-repeat: repeat;
    }
    .wrapper {
    width: 100%;
    max-width: 42em;
    max-height: 90vh;
    position: absolute;
    transform: translate(-50%, -50%);
    top: 50%;
    left: 50%;
    padding: 3em;
    border-radius: 1em;
    }
    .container {
    position: relative;
    width: 100%;
    height: 100%;
    }
    #wheel {
    max-height: inherit;
    width: inherit;
    top: 0;
    padding: 0;
    }
    @keyframes rotate {
    100% {
        transform: rotate(360deg);
    }
    }
    #spin-btn {
    position: absolute;
    transform: translate(-50%, -50%);
    top: 50%;
    left: 50%;
    height: 18%;
    width: 18%;
    border-radius: 50%;
    cursor: pointer;
    border: 0;
    background: radial-gradient(#e28c46 50%, #331c07 85%);
    color: #000000;
    text-transform: uppercase;
    font-size: 1.6em;
    letter-spacing: 0.1em;
    font-weight: 600;
    border: #000000 10px outset;
    }
    img {
    position: absolute;
    width: 4em;
    top: 45%;
    right: -8%;
    }
    #final-value {
    font-size: 1.5em;
    text-align: center;
    margin-top: 1.5em;
    color: #202020;
    font-weight: 500;
    }
    @media screen and (max-width: 768px) {
    .wrapper {
        font-size: 12px;
        padding: 1em;
        max-height: 95vh;
    }
    
    img.arrow {
        right: -15%;
    }

    h1 {
        font-size: 1.5em;
        margin-bottom: 20px;
    }

    #spin-btn {
        font-size: 1.8em;
    }

    /* Estilos responsivos para el modal */
    .modal-content {
        width: 90%;
        max-width: 300px;
        margin: 5% auto;
        padding: 15px;
    }

    .modal-image {
        width: 150px;
        height: 150px;
    }

    #modalMonsterName {
        font-size: 20px !important;
    }

    /* Ajustar el tamaño del texto en la ruleta */
    .chartjs-plugin-datalabels {
        font-size: 12px !important;
    }
    }
    @media screen and (max-width: 480px) {
    .wrapper {
        padding: 0.5em;
    }

    #spin-btn {
        font-size: 1em;
    }

    .modal-image {
        width: 120px;
        height: 120px;
    }
    }
    .nav-button {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 60px;
      height: 60px;
      background-color: #995a29;
      border: 2px solid #2e1a0b;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: transform 0.2s;
      z-index: 1000;
    }

    .nav-button:hover {
      transform: scale(1.1);
      background-color: #b0805b;
    }

    .nav-button img {
      width: 40px;
      height: 40px;
      position: static;
    }

    /* Estilos para el modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
    }

    .modal-content {
      background-color: #995a29;
      border: 4px solid #2e1a0b;
      margin: 15% auto;
      padding: 20px;
      width: 300px;
      border-radius: 15px;
      text-align: center;
    }

    .modal-image {
      width: 200px;
      height: 200px;
      margin: 10px auto;
      display: block;
    }

    .close-modal {
      color: #2e1a0b;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close-modal:hover {
      color: #000;
    }
  </style>
  <body>
    <a href="https://ellandeperez.github.io/MHBestiary/" class="nav-button">
      <img src="https://github.com/ellandeperez/MHBestiary/blob/main/MHImages/0_Icons/particons/m_gem.png?raw=true" alt="Home">
    </a>
    <h1 style="text-align: center; font-family: 'Albertus MT Std Regular'; color: #000000; text-shadow: 0px 0px 20px #ffb35d; top:25px; position: relative; z-index: 1;">
      MH WILDS ROULETTE
    </h1>
    <div class="wrapper">
      <div class="container">
        <canvas id="wheel"></canvas>
        <button style="font-family:'Albertus MT Std Regular';font-weight: bold;" id="spin-btn">Spin</button>
        <img class="arrow" style="transform: rotate(-90deg);width:75px;" src="https://github.com/ellandeperez/MHBestiary/blob/main/MHImages/0_Icons/slash.png?raw=true" alt="spinner arrow" />
      </div>
      <div id="final-value" >
        <p style="font-family:'Albertus MT Std Regular';font-weight: bold;">¡GIRA!</p>
      </div>
    </div>
    
    <!-- Añadir el modal -->
    <div id="monsterModal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2 id="modalMonsterName" style="font-family:'Albertus MT Std Regular';color:#2e1a0b;"></h2>
        <img style="position: relative;right:-5%;" id="modalMonsterImage" class="modal-image" src="" alt="Monster">
      </div>
    </div>

    <!-- Chart JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Chart JS Plugin for displaying text over chart -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.1.0/chartjs-plugin-datalabels.min.js"></script>
    <!-- Script -->
    <script src="script.js"></script>
  </body>
  <script>
    const wheel = document.getElementById("wheel");
    const spinBtn = document.getElementById("spin-btn");
    const finalValue = document.getElementById("final-value");

    const monsters = [
        'Ajarakan', 'Arkveld', 'Balahara', 'Blangonga', 'Chatacabra',
        'Congalala', 'Doshaguma', 'G. Anjanath F', 'G. Arkveld', 'G. Doshaguma',
        'G. Odogaron E', 'G. Rathalos', 'Gore Magala', 'Gravios', 'Gypceros',
        'Hirabami', 'Jin Dahaad', 'Lala Barina', 'Nerscylla', 'Nu Udra',
        'Quematrice', 'Rathalos', 'Rathian', 'Rey Dau', 'Rompopolo',
        'Uth Duna', 'Xu Wu', 'Yian Kut-Ku', 'Zoh Shia'
    ];

    // Crear un array con el mismo valor para cada sección
    const data = Array(monsters.length).fill(100/monsters.length);

    // Generar colores alternados
    const pieColors = monsters.map((_, index) => {
        return index % 2 === 0 ? '#b0805b' : '#995a29';
    });

    // Calcular los valores de rotación
    const rotationValues = monsters.map((_, index) => {
        const sectionSize = 360 / monsters.length;
        return {
            minDegree: index * sectionSize,
            maxDegree: (index + 1) * sectionSize,
            value: monsters[index]
        };
    });

    function updateChartFontSize() {
        const fontSize = window.innerWidth <= 768 ? 8 : 12;
        if (myChart) {
            myChart.options.plugins.datalabels.font.size = fontSize;
            myChart.update();
        }
    }

    window.addEventListener('resize', updateChartFontSize);

    let myChart = new Chart(wheel, {
        plugins: [ChartDataLabels],
        type: "pie",
        data: {
            labels: monsters,
            datasets: [{
                backgroundColor: pieColors,
                borderColor:'#2e1a0b',
                data: data,
            }],
        },
        options: {
            responsive: true,
            animation: { duration: 0 },
            plugins: {
                tooltip: false,
                legend: {
                    display: false,
                },
                datalabels: {
                    color: "#ffffff",
                    formatter: (_, context) => context.chart.data.labels[context.dataIndex],
                    font: { 
                        size: window.innerWidth <= 768 ? 11 : 18,
                        weight: 'bold',
                        family: 'Albertus MT Std Regular'
                    },
                    align: 'end',
                    anchor: 'center',
                    offset: -10,
                    textStrokeColor: 'black',
                    textStrokeWidth: 4,
                    rotation: (context) => {
                        const angle = context.chart.options.rotation || 0;
                        const sectionAngle = (360 / monsters.length);
                        return (angle + (context.dataIndex * sectionAngle) + sectionAngle/2 + -90);
                    }
                },
            },
        },
    });

    const valueGenerator = (angleValue) => {
        // La flecha apunta a la derecha (0 grados), necesitamos ajustar el ángulo
        let normalizedAngle = (-angleValue + 90) % 360;
        if (normalizedAngle < 0) normalizedAngle += 360;
        
        const sectionSize = 360 / monsters.length;
        const index = Math.floor(normalizedAngle / sectionSize);
        const monster = monsters[index];
        
        finalValue.innerHTML = `<p style="font-family:'Albertus MT Std Regular';font-weight: bold;font-size:32px;">¡${monster}!</p>`;
        
        // Mostrar el modal con la imagen
        const modal = document.getElementById("monsterModal");
        const modalName = document.getElementById("modalMonsterName");
        const modalImage = document.getElementById("modalMonsterImage");
        
        modalName.textContent = monster;
        modalImage.src = `https://github.com/ellandeperez/MHBestiary/blob/main/MHImages/${monster}/Icon.png?raw=true`;
        modal.style.display = "block";
        
        spinBtn.disabled = false;
    };

    // Añadir el código para cerrar el modal
    const modal = document.getElementById("monsterModal");
    const closeBtn = document.getElementsByClassName("close-modal")[0];

    closeBtn.onclick = function() {
        modal.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    let count = 0;
    let resultValue = 101;

    spinBtn.addEventListener("click", () => {
        spinBtn.disabled = true;
        finalValue.innerHTML = `<p style="font-family:'Albertus MT Std Regular';font-weight: bold;font-size:32px;">¡Girando!</p>`;
        
        const sectionSize = 360 / monsters.length;
        const randomSection = Math.floor(Math.random() * monsters.length);
        const finalRotation = -((randomSection * sectionSize) + 90);
        let currentRotation = 0;
        let totalSpins = 0;
        let rotationSpeed = 10; // Velocidad inicial más controlada
        
        let rotationInterval = window.setInterval(() => {
            currentRotation -= rotationSpeed;
            
            // Normalizar la rotación actual
            if (currentRotation <= -360) {
                currentRotation = 0;
                totalSpins++;
                rotationSpeed = Math.max(3, rotationSpeed * 0.5); // Reducción gradual de velocidad
            }

            // Comprobar condición de parada
            if (totalSpins >= 3 && rotationSpeed <= 3) {
                currentRotation = finalRotation; // Forzar posición final exacta
                myChart.options.rotation = currentRotation;
                myChart.update();
                valueGenerator(currentRotation);
                clearInterval(rotationInterval);
                spinBtn.disabled = false;
                return;
            }
            
            myChart.options.rotation = currentRotation;
            myChart.update();
        }, 20); // Intervalo más largo para mejor rendimiento
    });
  </script>
</html>